## LINUX에서 대상서버 접속여부 체크

자사의 솔루션은 AWS를 이용한 클라우드 서비스와 온프레미스 (On-Premise)로 진행하는 엔터프라이즈 사업을 진행 하고 있다. 금일에는 온프레미스로 사용중인 고객사에서 발생한 장애관련 처리 내용을 정리하려고 한다.

### 저주받은 텔레그램

온프레미스로 구성된 고객사의 서비스에는 스카우터를 통해서 서버의 JVM에러, 디스크 사용량, SQL 정보를 통한 슬로우 쿼리, 서버 장애 판단등을 용도로 사용하는데 서버에 에러가 발생하는 비율이 1%를 넘어가면 텔레그램으로 메시지가 오도록 설정이 되어져 있는 구조인데 오늘 3시간 가량 계속해서 에러가 발생해 텔레그램에 알람이 멈추지 않고 울리기 시작했다.

### fcm.googleapis.com

해당 서비스에서는 메일을 작성하면 fcm.googleapis.com를 통해서 처리하는 방식으로 되어져있는데 해당 서버로 연결하는 과정에서 어떤 경우에는 성공적으로 보내지고 어떤 경우에는 오류가 발생하는 현상이 발생했다.

### java.net.socketexception connect timed out

해당 서비스에서 발생한 에러의 내용이다 보통 서버에 연결이 되고 나서 에러가 발생하게 되면 connet time out 에러가 아니라 socket time out 에러가 발생 해야하는데 connet time out이 발생하는걸 보고 서버에 연결이 되지 않고 있다고 판단했다.

### Telnet

WAS 서버에 접속해 우선 Ping을 통해서 해당 서버에 연결이 되는지 체크하려고 했으니 ping을 막아두어서 Telnet을 통해서 80포트를 조회해보니 연결에는 WAS서버에서의 연결 문제는 없다고 생각이 들었고 네트워크 문제일 가능성이 있다고 생각하고 이를 해당 고객사 네트워크 팀에게 전달했다. (규모가 있는 고객사다 보니 네트워크 부분에 대한 권한을 주지는 않아서 요청을 해야만 했다)

### 네트워크

네트워크를 확인해보니 fcm.googleapis.com 도메인이 RR로 구성되어져 있다보니 특정 IP만 열려있고 특정 IP는 막혀있는 현상으로 인해 오늘 같은 서버 이슈가 발생한것으로 결론을 짓고 상황을 종료했다. 이후에 스카우터 모니터링을 1시간 가량 진행 했고 이상이 없는 것을 확인했다.

### Ping, Telnet, Traceroute

- Ping : 목적지 서버를 통하는 네트워크 상태를 체크

  ```
  ping 111.111.111.1

  PING 111.111.111.1 (204.111.111.1) : 56 data bytes
  64 bytes from 111.111.111.1: icmp_seq=0 ttl=228 time=95.552ms
  64 bytes from 111.111.111.1: icmp_seq=1 ttl=228 time=91.352ms
  64 bytes from 111.111.111.1: icmp_seq=2 ttl=228 time=100.252ms
  64 bytes from 111.111.111.1: icmp_seq=3 ttl=228 time=82.152ms
  ```

> 응답이 오지 않거나 시간이 너무 오래 걸리는 경우에는 연결이 안된다고 보면 된다.  
> ping 경우 DDOS 공격에 이용되기도 해서 ping을 막기도 하는데 이런 이유로 인해서  
> 고객사에서 ping에 대한 사용을 제한 한듯하다.

- Telnet : 목적지 서버의 해당 어플리케이션 상태까지 체크
  ```
  telnet 111.111.111.1 9002
  trying 111.111.111.1
  Connected to 111.111.111.1
  Escape character is '^]'.
  ```

> Connected to 111.111.111.1 결과가 나오면 해당 서버와 어플리케이션 상태가 정상  
> telnet: Unable to connect to remote host: Connection refused 의 경우 방화벽과 어플리케이션 상태가 비정상

- Traceroute : 출발지와 목적지 사이의 라우터를 모두 추적
  ```
  traceroute google.com
  traceroute to google.com (216.58.220.110), 64 hops max, 52 byte packets
  1  218.48.137.13 (218.48.137.13)  8.062 ms  6.813 ms  6.429 ms
  2  218.48.137.1 (218.48.137.1)  10.550 ms  10.492 ms  11.398 ms
  3  100.71.53.249 (100.71.53.249)  9.606 ms  10.033 ms  7.538 ms
  4  10.44.255.32 (10.44.255.32)  14.946 ms  8.100 ms
      10.44.255.34 (10.44.255.34)  8.488 ms
  5  10.222.18.124 (10.222.18.124)  9.024 ms
      10.222.18.136 (10.222.18.136)  17.396 ms
      10.222.18.146 (10.222.18.146)  8.471 ms
  6  10.222.23.203 (10.222.23.203)  8.123 ms
      10.222.22.105 (10.222.22.105)  17.492 ms
      10.222.25.239 (10.222.25.239)  7.817 ms
  7  72.14.195.250 (72.14.195.250)  65.726 ms  65.575 ms
  ```

> 구글로 가는 경로를 추적해본 결과
